<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Torneo Hockey Escolar</title>

  <!-- Bootstrap 5 (CDN) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    /* Estilos adicionales */
    body { padding-top: 70px; }
    .bye-badge { font-weight:700; color:#fff; background:#6c757d; padding:0.15rem 0.5rem; border-radius:0.25rem; }
    .admin-note { font-size:0.9rem; color:#6c757d; }
    .card-controls { gap:8px; }
    .file-input { display:inline-block; }
  </style>
</head>
<body>

  <!-- NAV -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">Torneo Hockey</a>
      <div class="d-flex align-items-center">
        <span id="modeBadge" class="badge bg-secondary me-3">Modo: ver</span>
        <a id="openAdmin" class="btn btn-sm btn-outline-light me-2" href="?modo=admin">Abrir admin</a>
        <a id="openView" class="btn btn-sm btn-outline-light" href="?modo=ver">Abrir ver</a>
      </div>
    </div>
  </nav>

  <main class="container">

    <!-- ADMIN TOOLS -->
    <div id="adminTools" class="card mb-3" style="display:none;">
      <div class="card-body d-flex justify-content-between align-items-center">
        <div>
          <h5 class="card-title mb-1">Herramientas Administrador</h5>
          <div class="admin-note">En este modo puedes editar marcadores. Los cambios se guardan en tu dispositivo (localStorage) y no serán sobrescritos por datos.json remoto salvo que importes manualmente un JSON.</div>
        </div>
        <div class="d-flex card-controls">
          <label class="btn btn-outline-primary mb-0 file-input">
            <input id="fileImport" type="file" accept=".json" style="display:none">
            Cargar simulación
          </label>
          <button id="btnExportJSON" class="btn btn-outline-success">Exportar JSON</button>
          <button id="btnResetLocal" class="btn btn-outline-danger">Borrar datos locales</button>
        </div>
      </div>
    </div>

    <!-- Aviso BYE si corresponde -->
    <div id="byeAlert" class="alert alert-info" style="display:none;"></div>

    <!-- Contenedor principal (liguilla, jornadas, etc.) -->
    <div id="torneoContainer"></div>

    <!-- Footer ayuda -->
    <footer class="mt-4">
      <small class="text-muted">Si quieres subir cambios permanentes a GitHub: usa <code>Exportar JSON</code> y sube el archivo resultante como <code>datos.json</code> en tu repo (o hazlo manualmente desde Git).</small>
    </footer>
  </main>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    /**************************************************************************
     *  Variables y detección de modo
     **************************************************************************/
    const urlParams = new URLSearchParams(window.location.search);
    const MODO = urlParams.get("modo") === "admin" ? "admin" : "ver";

    // Cambiar badge del nav
    document.getElementById("modeBadge").textContent = "Modo: " + MODO;

    /**************************************************************************
     *  localStorage helpers
     **************************************************************************/
    function getLocalData() {
      const raw = localStorage.getItem("torneoData");
      if (!raw) return null;
      try { return JSON.parse(raw); } catch (e) { console.error("JSON local corrupto", e); return null; }
    }

    function saveLocalData(obj) {
      try {
        localStorage.setItem("torneoData", JSON.stringify(obj));
      } catch (e) {
        console.error("Error guardando en localStorage:", e);
        alert("Error guardando en localStorage. Revisa la consola.");
      }
    }

    function clearLocalData() {
      localStorage.removeItem("torneoData");
    }

    /**************************************************************************
     *  Cargar datos remotos (datos.json) solo si no hay local
     **************************************************************************/
    async function loadInitialData() {
      const local = getLocalData();
      if (local) {
        console.log("Usando datos desde localStorage");
        return local;
      }
      console.log("No hay datos locales: cargando datos.json");
      try {
        const resp = await fetch("datos.json", {cache: "no-store"});
        if (!resp.ok) throw new Error("HTTP " + resp.status);
        const json = await resp.json();
        saveLocalData(json);
        return json;
      } catch (err) {
        console.error("Error cargando datos.json:", err);
        return { jornadas: [], equipos: [] };
      }
    }

    /**************************************************************************
     *  BYE: si hay número impar de equipos, añadimos uno "BYE"
     **************************************************************************/
    function ensureBye(equipos) {
      // equipos: array de strings o objetos con nombre
      if (!Array.isArray(equipos)) return equipos;
      if (equipos.length % 2 === 1) {
        // comprobar si ya existe BYE
        const exists = equipos.some(e => (typeof e === "string" && e.toLowerCase().includes("bye")) || (e.nombre && e.nombre.toLowerCase().includes("bye")));
        if (!exists) {
          // añadimos BYE (como string para compatibilidad)
          equipos.push("BYE");
          return { addedBye: true, equipos };
        }
      }
      return { addedBye: false, equipos };
    }

    /**************************************************************************
     *  Exportar datos locales a fichero JSON
     **************************************************************************/
    function exportarJSON() {
      const data = getLocalData() || { jornadas: [], equipos: [] };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "torneo_hockey_export_" + Date.now() + ".json";
      a.click();
      URL.revokeObjectURL(url);
    }

    /**************************************************************************
     *  Importar JSON desde fichero (solo en admin)
     **************************************************************************/
    function handleFileImport(file) {
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const imported = JSON.parse(e.target.result);
          // Validación suave
          if (!imported || typeof imported !== "object") throw new Error("JSON no válido");
          // Confirmar sobreescritura
          const ok = confirm("Vas a importar un JSON que reemplazará los datos locales. ¿Continuar?");
          if (!ok) return;
          saveLocalData(imported);
          alert("Importación completa. La página se recargará para aplicar cambios.");
          location.reload();
        } catch (err) {
          console.error("Error importando JSON:", err);
          alert("El archivo JSON no es válido.");
        }
      };
      reader.readAsText(file);
    }

    /**************************************************************************
     *  Guardar cambios desde UI (modo admin)
     **************************************************************************/
    function guardarCambios(data) {
      if (MODO !== "admin") return;
      saveLocalData(data);
      // Opción: crear snapshot / backup (se podría ampliar)
      // Guardado notificación
      const t = document.createElement("div");
      t.className = "toast align-items-center text-bg-success border-0 position-fixed";
      t.style.top = "80px";
      t.style.right = "20px";
      t.style.zIndex = 9999;
      t.innerHTML = `<div class="d-flex">
        <div class="toast-body">Cambios guardados en localStorage.</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>`;
      document.body.appendChild(t);
      const bsToast = new bootstrap.Toast(t);
      bsToast.show();
      setTimeout(() => t.remove(), 3500);
    }

    /**************************************************************************
     *  Render / UI (ejemplo general). Aquí debes integrar tu lógica real de
     *  cálculo de clasificación, jornadas, etc. Mantengo la estructura
     *  para que no rompa tu código previo.
     **************************************************************************/
    function initPage(data, modo, onSave) {
      const container = document.getElementById("torneoContainer");
      container.innerHTML = "";

      // Aseguramos estructura mínima
      data.jornadas = data.jornadas || [];
      data.equipos = data.equipos || [];

      // BYE handling (solo para mostrar aviso)
      const resBye = ensureBye(data.equipos);
      if (resBye.addedBye) {
        document.getElementById("byeAlert").style.display = "block";
        document.getElementById("byeAlert").innerHTML = `<strong>Se ha añadido automáticamente el equipo <span class="bye-badge">BYE</span> porque había un número impar de equipos.</strong>`;
        // Guardamos equipos actualizados en data para que se use
        data.equipos = resBye.equipos;
        // Guardamos local (solo si admin): dejamos que en modo ver también se muestre BYE sin sobrescribir si no quieres
        // No forzamos guardado aquí — mantenemos responsabilidad en admin
      } else {
        document.getElementById("byeAlert").style.display = "none";
      }

      // TITULO
      const titulo = document.createElement("div");
      titulo.className = "mb-3 d-flex justify-content-between align-items-center";
      titulo.innerHTML = `<div>
          <h2 class="h5 mb-0">Clasificación y Jornadas</h2>
          <small class="text-muted">Equipos: ${data.equipos.length}</small>
        </div>`;
      container.appendChild(titulo);

      // MOSTRAR EQUIPOS
      const equiposCard = document.createElement("div");
      equiposCard.className = "card mb-3";
      equiposCard.innerHTML = `<div class="card-body">
        <h5 class="card-title">Equipos</h5>
        <div id="equiposList" class="d-flex flex-wrap gap-2"></div>
        </div>`;
      container.appendChild(equiposCard);

      const equiposList = equiposCard.querySelector("#equiposList");
      data.equipos.forEach((eq, idx) => {
        const name = (typeof eq === "string") ? eq : (eq.nombre || ("Equipo " + (idx+1)));
        const span = document.createElement("span");
        span.className = "badge bg-primary";
        span.textContent = name;
        equiposList.appendChild(span);
      });

      // MOSTRAR JORNADAS Y PARTIDOS
      const jornadasCard = document.createElement("div");
      jornadasCard.className = "card";
      jornadasCard.innerHTML = `<div class="card-body">
        <h5 class="card-title">Jornadas</h5>
        <div id="jornadasList"></div>
        </div>`;
      container.appendChild(jornadasCard);

      const jl = jornadasCard.querySelector("#jornadasList");
      if (!Array.isArray(data.jornadas) || data.jornadas.length === 0) {
        jl.innerHTML = `<div class="alert alert-warning mb-0">No hay jornadas definidas.</div>`;
      } else {
        data.jornadas.forEach((j, ji) => {
          const jDiv = document.createElement("div");
          jDiv.className = "mb-3 p-2 border rounded";
          jDiv.innerHTML = `<h6>Jornada ${ji+1}</h6>`;
          // Partidos
          (j.partidos || []).forEach((p, pi) => {
            const row = document.createElement("div");
            row.className
