<!DOCTYPE html>
<html lang="gl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>üèë XIX Torneo de Nadal de h√≥ckey CEIP Bala√≠dos ‚Äì Xesti√≥n</title>
<style>
  html,body{margin:0;padding:0;width:100%;overflow-x:hidden;font-family:Inter,"Segoe UI",Roboto,system-ui,-apple-system,"Helvetica Neue",Arial;background:linear-gradient(180deg,#f0f9ff,#fff);color:#0f172a}:root{--accent:#0056b3;--accent-2:#00a8ff;--muted:#6b7280;--card:#ffffff;--gold:#ffc107;--success:#28a745;--danger:#dc3545}.wrap{max-width:1400px;margin:24px auto;padding:18px;box-sizing:border-box}.page{background:var(--card);border-radius:12px;padding:18px;box-shadow:0 8px 30px rgba(6,10,15,.06);border:1px solid rgba(0,0,0,.03)}header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}.title{display:flex;gap:12px;align-items:center}.logo{height:40px;width:40px;border-radius:50%;object-fit:contain;background:#fff;border:1px solid #eee}h1{margin:0;font-size:1.25rem;background:linear-gradient(90deg,var(--accent),var(--accent-2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}  .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}button{font-family:inherit;cursor:pointer;border-radius:8px;border:none;padding:8px 10px;background:var(--accent);color:#fff;box-shadow:0 6px 12px rgba(0,86,179,.12);transition:all .3s ease;transform:translateY(0)}button:hover{transform:translateY(-2px);box-shadow:0 8px 16px rgba(0,86,179,.2);filter:brightness(1.1)}button:active{transform:translateY(0);box-shadow:0 4px 8px rgba(0,86,179,.15)}button.gray{background:#6b7280}button.gray:hover{background:#4b5563}button.warn{background:var(--gold);color:#111}button.warn:hover{background:#ffb800;box-shadow:0 8px 16px rgba(255,193,7,.25)}button.danger{background:var(--danger)}button.danger:hover{background:#c82333;box-shadow:0 8px 16px rgba(220,53,69,.25)}button.projector-btn{background:#5a67d8}button.projector-btn:hover{background:#4c5bc7;box-shadow:0 8px 16px rgba(90,103,216,.25)}button:disabled{opacity:0.5;cursor:not-allowed;transform:none!important}button:disabled:hover{box-shadow:0 6px 12px rgba(0,86,179,.12);filter:none}
  .filter-bar{display:flex;gap:6px;margin:0 0 20px 0;padding-bottom:20px;border-bottom:1px solid #eef6ff;flex-wrap:wrap}
  .filter-bar button{background:var(--muted);opacity:.7;padding:6px 8px;font-size:.85rem;transition:all .3s ease}
  .filter-bar button:hover{opacity:1;transform:translateY(-2px)}
  .filter-bar button.active{background:var(--accent);opacity:1}
  .main-grid{display:flex;flex-direction:column;gap:24px;margin-top:16px}
  @media (min-width:768px){
    .content-wrapper{display:grid;grid-template-columns:1fr;gap:24px}
  }
  .card{background:linear-gradient(180deg,#fff,#fbfdff);padding:14px;border-radius:10px;box-shadow:0 6px 18px rgba(2,6,23,.03);border:1px solid rgba(3,105,161,.04);margin-bottom:16px}.groups-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:16px}  .group-card{padding:14px;border-radius:10px;background:#fff;border:1px solid #e2e8f0;transition:all .3s ease}
  .group-card:hover{box-shadow:0 4px 12px rgba(0,86,179,.08);transform:translateY(-2px)}
  .group-card h3{margin:0 0 8px;color:var(--accent);font-size:1rem}
  .section-title{display:inline-block;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;padding:8px 16px;border-radius:8px;margin-bottom:12px;font-weight:bold;font-size:0.95rem}
  .teams-list{display:flex;flex-direction:column;gap:8px}
  .team-entry{display:flex;align-items:center;gap:8px}
  .team-entry .shield-preview{width:24px;height:24px;border-radius:4px;object-fit:cover;background:#eee;flex-shrink:0}
  .team-entry .inputs-wrapper{flex-grow:1;display:flex;flex-direction:column;gap:4px}
  .team-entry .shield-input{display:none}
  .team-entry.edit-shield .shield-input{display:block}
  .team-entry .photo-input{display:none}
  .team-entry.edit-photos .photo-input{display:block}
  .photo-preview{width:100%;max-width:200px;height:auto;border-radius:8px;margin-top:8px;display:none;box-shadow:0 2px 8px rgba(0,0,0,0.1)}
  .photo-preview.visible{display:block}
  .teams-list input{padding:8px;border-radius:8px;border:1px solid #e9f2ff;background:#fbfeff;box-sizing:border-box;width:100%;transition:all .3s ease}
  .teams-list input:focus{border-color:var(--accent);outline:none;box-shadow:0 0 0 3px rgba(0,86,179,.1);transform:translateY(-1px)}
  .shield-image{width:24px;height:24px;border-radius:4px;object-fit:cover;margin-right:8px;vertical-align:middle;background:#eee;transition:transform .3s ease}
  .shield-image:hover{transform:scale(1.15)}.matches-container{margin-top:10px;display:flex;flex-direction:column;gap:8px;max-height:300px;overflow:auto;padding-right:6px}
  .matches-container.collapsed{max-height:0;overflow:hidden;margin-top:0;padding:0}
  .round-header{color:var(--accent);font-weight:700;background-color:#f0f9ff;padding:6px 8px;border-radius:6px;margin-top:10px}.resting-team{font-style:italic;color:var(--muted);text-align:center;padding:4px}.match{display:flex;justify-content:space-between;align-items:center;gap:8px;padding:8px;border-radius:8px;background:linear-gradient(180deg,#f7fbff,#fff);border:1px solid rgba(0,100,180,.04)}.match .teams{font-weight:600;flex-grow:1}
  .fair-play-checkbox{margin-left:8px;transform:scale(1.2);cursor:pointer}
  .award-section{margin-top:16px;padding:12px;background:linear-gradient(135deg,#fff5e6,#ffe6cc);border-radius:8px;border:1px solid #ffc107}
  .award-item{display:flex;align-items:center;gap:8px;padding:8px;background:#fff;border-radius:6px;margin-bottom:8px}
  .award-medal{font-size:1.5rem}
  .award-photo{width:80px;height:80px;object-fit:cover;border-radius:6px;border:2px solid #ffc107;transition:all .3s ease;cursor:pointer}
  .award-photo:hover{transform:scale(1.5);z-index:10;box-shadow:0 8px 24px rgba(0,0,0,.2)}
  .gallery-section{margin-top:16px;padding:16px;background:#f8f9fa;border-radius:8px}
  .gallery-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:16px;margin-top:12px}
  .gallery-item{background:#fff;border-radius:8px;padding:12px;box-shadow:0 2px 8px rgba(0,0,0,0.1);transition:all .3s ease;cursor:pointer}
  .gallery-item:hover{transform:translateY(-4px);box-shadow:0 8px 20px rgba(0,0,0,.15)}
  .gallery-item img{width:100%;height:150px;object-fit:cover;border-radius:6px;margin-bottom:8px;transition:all .3s ease}
  .gallery-item:hover img{transform:scale(1.05)}
  .gallery-item-name{font-weight:bold;color:var(--accent);text-align:center}
  .confetti{position:fixed;width:10px;height:10px;background:#f0f;pointer-events:none;z-index:10000;animation:confetti-fall 3s linear forwards}
  @keyframes confetti-fall{0%{transform:translateY(-100vh) rotate(0deg);opacity:1}100%{transform:translateY(100vh) rotate(720deg);opacity:0}}
  .champion-badge{animation:champion-pulse 2s ease-in-out infinite}
  @keyframes champion-pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
  .color-picker{position:fixed;top:80px;right:18px;background:#fff;padding:12px;border-radius:10px;box-shadow:0 8px 30px rgba(0,0,0,.15);z-index:9998;display:none}
  .color-picker.show{display:block}
  .color-picker h4{margin:0 0 10px;font-size:0.9rem;color:#333}
  .color-options{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  .color-option{width:40px;height:40px;border-radius:50%;cursor:pointer;border:3px solid transparent;transition:all .3s ease;position:relative}
  .color-option:hover{transform:scale(1.15);border-color:#fff;box-shadow:0 4px 12px rgba(0,0,0,.2)}
  .color-option.active{border-color:#333;box-shadow:0 0 0 2px #fff, 0 0 0 4px #333}
  .color-option.active::after{content:'‚úì';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#fff;font-weight:bold;font-size:1.2rem;text-shadow:0 1px 3px rgba(0,0,0,.3)}
  #btn-color-picker{position:fixed;top:80px;right:18px;z-index:9999;width:50px;height:50px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.5rem;padding:0}
  body[data-theme="blue"]{--accent:#0056b3;--accent-2:#00a8ff}
  body[data-theme="green"]{--accent:#059669;--accent-2:#10b981}
  body[data-theme="red"]{--accent:#dc2626;--accent-2:#ef4444}
  body[data-theme="purple"]{--accent:#7c3aed;--accent-2:#a78bfa}
  body[data-theme="orange"]{--accent:#ea580c;--accent-2:#fb923c}
  body[data-theme="pink"]{--accent:#db2777;--accent-2:#ec4899}
  body[data-theme="dark"]{--accent:#60a5fa;--accent-2:#3b82f6;--muted:#9ca3af;--card:#1f2937;--gold:#fbbf24;--success:#34d399;--danger:#f87171;background:#111827;color:#f3f4f6}
  body[data-theme="dark"] .page{background:#1f2937;box-shadow:0 8px 30px rgba(0,0,0,.4)}
  body[data-theme="dark"] .card{background:#374151;border:1px solid #4b5563}
  body[data-theme="dark"] .group-card{background:#1f2937;border:1px solid #374151}
  body[data-theme="dark"] h1{background:linear-gradient(90deg,#60a5fa,#3b82f6);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
  body[data-theme="dark"] h2,body[data-theme="dark"] h3,body[data-theme="dark"] h4{color:#f3f4f6}
  body[data-theme="dark"] .subtitle{color:#9ca3af}
  body[data-theme="dark"] input{background:#374151;border-color:#4b5563;color:#f3f4f6}
  body[data-theme="dark"] input:focus{border-color:#60a5fa}
  body[data-theme="dark"] table{color:#f3f4f6}
  body[data-theme="dark"] th{color:#60a5fa}
  body[data-theme="dark"] td{border-bottom:1px dashed #374151}
  body[data-theme="dark"] .match{background:#1f2937;border:1px solid #374151}
  body[data-theme="dark"] .round-header{background:#374151;color:#60a5fa}
  body[data-theme="dark"] .award-section{background:#374151;border:1px solid #4b5563}
  body[data-theme="dark"] .award-item{background:#1f2937}
  body[data-theme="dark"] .playoff-match{background:#374151;border:1px solid #4b5563}
  body[data-theme="dark"] .playoff-section{background:#1f2937}
  body[data-theme="dark"] .gallery-item{background:#374151}
  body[data-theme="dark"] .color-picker{background:#1f2937;color:#f3f4f6}
  body[data-theme="dark"] .banner{background:linear-gradient(90deg,#60a5fa,#3b82f6)}
  table{width:100%;border-collapse:collapse;font-size:.85rem;margin-top:10px;table-layout:auto}
  th,td{padding:6px;text-align:left;border-bottom:1px dashed #eef6ff; white-space: nowrap;}
  th.team-col, td.team-col { width: 100%; white-space: normal; }
  th{color:var(--accent);font-size:.8rem}
  td{font-size:.9rem}
  td.num,th.num{text-align:center;width:38px}
  .playoff-match{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;background:#fff9f0;border:1px solid rgba(0,0,0,.03);margin-bottom:8px;flex-wrap:wrap}
  .playoff-section{margin-top:16px;padding:12px;background:#f8f9fa;border-radius:8px}
  .playoff-section h5{margin:0 0 8px;color:var(--accent);font-size:0.9rem}
  .extra-time-section{margin-top:8px;padding:8px;background:#fff3cd;border-radius:6px;border:1px dashed #ffc107}
  .extra-time-label{font-size:0.75rem;color:#856404;font-weight:600;margin-bottom:4px}
  .penalty-section{margin-top:8px;padding:8px;background:#f8d7da;border-radius:6px;border:1px dashed #dc3545}
  .penalty-label{font-size:0.75rem;color:#721c24;font-weight:600;margin-bottom:4px}
  .score-inputs{display:flex;align-items:center;gap:6px}
  footer{margin-top:14px;text-align:center;color:var(--muted);font-size:.9rem}.banner{position:fixed;right:18px;top:18px;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 8px 30px rgba(0,0,0,.12);display:none;z-index:9999}
  body.projector-mode{font-size:115%;background:#fff}
  .projector-mode .header,.projector-mode .admin-actions-container,.projector-mode footer,.projector-mode .controls,.projector-mode .filter-bar,.projector-mode .management-section{display:none}
  .projector-mode .main-grid{gap:16px}
  .projector-mode .wrap{max-width:100%;padding:10px}
  .projector-mode .page{box-shadow:none;border:none}
  .projector-mode .matches-container:not(.collapsed){max-height:none}
  .projector-mode button[id^="btn-toggle-matches"]{display:inline-block!important}
  .projector-mode button[id^="btn-toggle-shields"]{display:none!important}
  .projector-mode button[id^="btn-toggle-photos"]{display:none!important}
  #projectorModeBtnExit{position:fixed;top:10px;right:10px;z-index:1000}
  @media print{body{background:#fff}.banner,button,.controls{display:none!important}.page{box-shadow:none;border:none;margin:0;border-radius:0}}
  /* CORRECCI√ìN VITAL: Eliminamos .management-section da lista de elementos ocultos en view-mode */
  .view-mode .controls, .view-mode .admin-actions-container, .view-mode button[id^="btn-add-team"], .view-mode button[id^="btn-remove-team"], .view-mode button[id^="btn-save-teams"], .view-mode button[id^="btn-gen-schedule"], .view-mode button[id^="btn-clear-matches"], .view-mode button[id^="btn-toggle-shields"], .view-mode button[id^="btn-toggle-photos"], .view-mode button[id^="btn-gen-playoffs"], .view-mode button[id^="btn-toggle-all-liga"] { display: none !important; }
  .view-mode input { pointer-events: none; background: #fdfdfd !important; border-color: transparent !important; }
  .view-mode .teams-list { gap: 4px; }
  .view-mode .team-entry { padding: 8px; background: #f8f9fa; border-radius: 6px; }
  .view-mode input.name-input { font-weight: bold; color: var(--accent); }
  .view-mode #gallery-section{display:block!important}
  .liga-content-hidden{display:none!important}
</style>
</head>
<body data-theme="blue">
<button id="btn-color-picker" class="projector-btn" title="Cambiar colores">üé®</button>
<div id="color-picker" class="color-picker">
  <h4>üé® Colores do Torneo</h4>
  <div class="color-options">
    <div class="color-option active" data-theme="blue" style="background:linear-gradient(135deg,#0056b3,#00a8ff)" title="Azul Cl√°sico"></div>
    <div class="color-option" data-theme="green" style="background:linear-gradient(135deg,#059669,#10b981)" title="Verde"></div>
    <div class="color-option" data-theme="red" style="background:linear-gradient(135deg,#dc2626,#ef4444)" title="Vermello"></div>
    <div class="color-option" data-theme="purple" style="background:linear-gradient(135deg,#7c3aed,#a78bfa)" title="P√∫rpura"></div>
    <div class="color-option" data-theme="orange" style="background:linear-gradient(135deg,#ea580c,#fb923c)" title="Laranxa"></div>
    <div class="color-option" data-theme="pink" style="background:linear-gradient(135deg,#db2777,#ec4899)" title="Rosa"></div>
    <div class="color-option" data-theme="dark" style="background:linear-gradient(135deg,#111827,#374151)" title="üåô Modo Nocturno">
      <span style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:1.3rem">üåô</span>
    </div>
  </div>
</div>
<div class="wrap">
  <div class="page" id="page">
    <header class="header">
      <div class="title">
        <img src="http://www.edu.xunta.gal/centros/ceipbalaidos/system/files/u2/logo2.JPG" alt="Logo CEIP Bala√≠dos" class="logo">
        <div>
          <h1 id="mainTitle">üèë XIX Torneo de Nadal de h√≥ckey CEIP Bala√≠dos</h1>
          <p class="subtitle" id="subtitle">Xestiona equipos, resultados e eliminatorias</p>
        </div>
      </div>
      <div class="controls">
        <input id="schoolYear" class="year-input" type="text" value="2025‚Äì2026" title="Curso escolar" style="padding:8px;border-radius:8px;border:1px solid #ddd">
        <button id="btn-save-year">üíæ Gardar</button>
        <button id="btn-print" class="gray">üñ®Ô∏è Imprimir</button>
        <button id="btn-projector" class="projector-btn">üñ•Ô∏è Proxector</button>
      </div>
    </header>

    <div class="main-grid">
      <div class="content-wrapper">
        <!-- LIGA EN CAJA -->
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <h3 style="margin:0;color:var(--accent)">üèë üìä LIGA</h3>
            <button id="btn-toggle-all-liga" class="gray" style="padding:6px 12px;font-size:0.85rem">üëÅÔ∏è Ocultar Todo</button>
          </div>
          <div id="liga-content">
            <div class="filter-bar">
              <button id="btn-filter-all" class="active">Ver Todo</button>
              <button id="btn-filter-c2">2¬∫ Ciclo</button>
              <button id="btn-filter-c3">3¬∫ Ciclo</button>
              <button id="btn-filter-3" class="gray">3¬∫</button>
              <button id="btn-filter-4" class="gray">4¬∫</button>
              <button id="btn-filter-5" class="gray">5¬∫</button>
              <button id="btn-filter-6" class="gray">6¬∫</button>
            </div>
        
            <div id="cycle-2-container" class="cycle-container">
              <h2 style="margin:0;color:var(--accent)">2¬∫ Ciclo (3¬∫ e 4¬∫)</h2>
              <div id="level-3-container" class="level-container">
                <h3 style="margin:16px 0 8px; color:var(--muted)">Curso 3¬∫</h3>
                <div class="groups-grid" id="groupsContainer3"></div>
              </div>
               <div id="level-4-container" class="level-container">
                <h3 style="margin:16px 0 8px; color:var(--muted)">Curso 4¬∫</h3>
                <div class="groups-grid" id="groupsContainer4"></div>
              </div>
            </div>
            
            <div id="cycle-3-container" class="cycle-container" style="margin-top: 24px;">
              <h2 style="margin:0;color:var(--accent)">3¬∫ Ciclo (5¬∫ e 6¬∫)</h2>
              <div id="level-5-container" class="level-container">
                 <h3 style="margin:16px 0 8px; color:var(--muted)">Curso 5¬∫</h3>
                <div class="groups-grid" id="groupsContainer5"></div>
              </div>
               <div id="level-6-container" class="level-container">
                 <h3 style="margin:16px 0 8px; color:var(--muted)">Curso 6¬∫</h3>
                <div class="groups-grid" id="groupsContainer6"></div>
              </div>
            </div>
          </div>
        </div>
        <!-- FIN LIGA EN CAJA -->

        <!-- FASE FINAL -->
        <div class="card">
          <h3 style="margin:0;color:var(--accent)">üèÜ Fase Final</h3>
          <div class="admin-actions-container" style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
            <button id="btn-gen-playoffs-2" class="warn">ü•á Xerar 2¬∫ ciclo</button>
            <button id="btn-gen-playoffs-3" class="warn">ü•á Xerar 3¬∫ ciclo</button>
          </div>
          <div id="playoffsArea"></div>
        </div>

        <!-- GESTI√ìN DEL TORNEO -->
        <div class="card management-section">
          <h3 style="margin:0;color:var(--accent)">‚öôÔ∏è Xesti√≥n de datos</h3>
          <p class="subtitle" style="margin:8px 0">Os cambios g√°rdanse en tempo real na nube.</p>
          
          <!-- LOGIN E CONTROIS -->
          <div id="login-area" style="margin-bottom:10px; padding:10px; background:#e3f2fd; border-radius:8px; display:none;">
            <span id="user-display" style="font-weight:bold; color:var(--accent); margin-right:10px"></span>
            <button id="btn-logout" class="gray">Pechar Sesi√≥n</button>
          </div>

          <div id="admin-controls" style="display:none; gap:8px; flex-wrap:wrap;">
            <button id="btn-export">üì§ Exportar</button>
            <button id="btn-export-excel" class="warn">üìä Excel</button>
            <button id="btn-toggle-gallery" class="gray">üì∑ Galer√≠a</button>
            <button id="btn-reset" class="danger">üóëÔ∏è Reiniciar</button>
          </div>

          <div id="login-btn-container" style="margin-top:10px">
            <button id="btn-login-google" class="projector-btn">üîí Acceso Profesor (Editar)</button>
          </div>

          <hr style="margin:12px 0;border:none;border-top:1px dashed #eef6ff" />
          <h4 style="margin:0;color:var(--accent)">üìä Resumo Xeral</h4>
          <div id="summary" style="margin-top:8px; color:var(--muted)"></div>
          <div id="podium" style="margin-top:8px; color:var(--muted)"></div>
        </div>
        
        <!-- GALER√çA DE EQUIPOS (solo en modo ver) -->
        <div class="card" id="gallery-section" style="display:none">
          <h3 style="margin:0;color:var(--accent)">üì∑ Galer√≠a de Equipos</h3>
          <div id="galleryArea" class="gallery-grid"></div>
        </div>
      </div>
    </div>
    <footer style="padding: 24px 0 12px 0; text-align: center; color: var(--muted); font-size: .9rem;">CEIP Bala√≠dos ‚Äì Torneo de Nadal ‚Ä¢ Dese√±o e xesti√≥n en galego.</footer>
  </div>
</div>
<div id="banner" class="banner"></div>
<button id="btn-exit-projector" class="projector-btn" style="display:none;position:fixed;top:10px;right:10px;z-index:1000">‚¨ÖÔ∏è Sa√≠r do Modo Proxector</button>

<!-- FIREBASE SDKs -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  
  // 1. CONFIGURACI√ìN DE FIREBASE
  const firebaseConfig = {
    apiKey: "AIzaSyAnLlD1ctd6C0QBTZtdFgpzJ5KRL8ztd5M",
    authDomain: "torneo-hockey.firebaseapp.com",
    databaseURL: "https://torneo-hockey-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "torneo-hockey",
    storageBucket: "torneo-hockey.firebasestorage.app",
    messagingSenderId: "418864031332",
    appId: "1:418864031332:web:1a6aed6b1920524165e171"
  };

  // Inicializar Firebase
  if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
  }
  const db = firebase.database();
  const auth = firebase.auth();

  const urlParams = new URLSearchParams(window.location.search);
  const isViewMode = urlParams.get('modo') === 'ver';

  window.torneoApp = {
    config: {
      GROUPS: { '3A': '3', '3B': '3', '4A': '4', '4B': '4', '5A': '5', '5B': '5', '6A': '6', '6B': '6' },
      LEVELS: { '3': ['3A', '3B'], '4': ['4A', '4B'], '5': ['5A', '5B'], '6': ['6A', '6B'] },
      CYCLES: { 'c2': ['3', '4'], 'c3': ['5', '6'] },
      THEME_KEY: 'ceip_balaidos_theme',
      BASE_EDIT_YEAR: 2025,
      BASE_EDITION_NUM: 19,
      isViewMode: isViewMode
    },
    state: {},
    user: null,

    init: function() {
      this.loadTheme();
      
      const btnLog = document.getElementById('btn-login-google');
      if(btnLog) btnLog.addEventListener('click', () => this.login());
      const btnOut = document.getElementById('btn-logout');
      if(btnOut) btnOut.addEventListener('click', () => this.logout());

      this.bindEvents();

      // Escoitar cambios en tempo real
      db.ref('torneo').on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
          this.state = data;
          console.log("üî• Datos recibidos en tempo real!");
        } else {
          this.initEmptyState();
        }
        this.sanitizeState();
        this.renderAll();
      });

      // Xestionar usuario
      auth.onAuthStateChanged((user) => {
        this.user = user;
        this.updateAdminUI();
      });
    },

    saveState: function() {
      if (this.user) {
        db.ref('torneo').set(this.state)
          .then(() => console.log("‚òÅÔ∏è Gardado"))
          .catch((e) => alert("Erro ao gardar: " + e.message));
      }
    },

    updateAdminUI: function() {
      const loginArea = document.getElementById('login-area');
      const adminControls = document.getElementById('admin-controls');
      const loginBtnContainer = document.getElementById('login-btn-container');
      const userDisplay = document.getElementById('user-display');
      
      // Protexer controis de edici√≥n
      const protectedElements = document.querySelectorAll(
        '.teams-list input, button[id^="btn-add"], button[id^="btn-remove"], button[id^="btn-save"], button[id^="btn-gen"], button[id^="btn-clear"], input[type="number"], input[type="checkbox"], button[id^="btn-gen-playoffs"], .score-inputs input, button[id^="btn-toggle-shields"], button[id^="btn-toggle-photos"]'
      );

      if (this.user) {
        // ADMIN
        loginArea.style.display = 'block';
        userDisplay.textContent = "üë§ " + this.user.email;
        adminControls.style.display = 'flex';
        loginBtnContainer.style.display = 'none';
        
        protectedElements.forEach(el => {
            el.disabled = false;
            el.style.pointerEvents = 'auto';
            el.style.opacity = '1';
            // Restaurar estilos de input
            if(el.tagName === 'INPUT' && el.type === 'text') {
               el.style.backgroundColor = '#fbfeff'; 
               el.style.border = '1px solid #e9f2ff';
            }
        });
        document.body.classList.remove('view-mode');

      } else {
        // ALUMNO
        loginArea.style.display = 'none';
        adminControls.style.display = 'none';
        
        if (!this.config.isViewMode) {
            loginBtnContainer.style.display = 'block';
        } else {
            loginBtnContainer.style.display = 'none';
        }

        protectedElements.forEach(el => {
            el.disabled = true;
            // Estilo limpo para inputs desactivados
            if(el.tagName === 'INPUT' && el.type === 'text') {
                el.style.backgroundColor = 'transparent';
                el.style.border = 'none';
                el.style.fontWeight = 'bold';
                el.style.color = 'var(--accent)';
            }
        });
        document.body.classList.add('view-mode');
      }
    },

    login: function() {
      const email = prompt("‚úâÔ∏è Email do profesor:");
      if(!email) return;
      const pass = prompt("üîë Contrasinal:");
      if(!pass) return;

      auth.signInWithEmailAndPassword(email, pass)
        .then(() => this.showBanner("‚úÖ Benvido/a, Profe!"))
        .catch(e => alert("Erro de acceso: " + e.message));
    },

    logout: function() {
      auth.signOut();
      setTimeout(() => window.location.reload(), 500);
    },

    initEmptyState: function() {
      this.state = { year: '2025‚Äì2026', groups: {}, playoffs: { '2ciclo': null, '3ciclo': null }, filter: 'all', collapsedGroups: {}, ligaHidden: false };
      Object.keys(this.config.GROUPS).forEach(g => this.state.groups[g] = { teams: [], rounds: [] });
    },

    sanitizeState: function() {
      if(!this.state.groups) this.state.groups = {};
      Object.keys(this.config.GROUPS).forEach(g => {
        if (!this.state.groups[g]) this.state.groups[g] = { teams: [], rounds: [] };
      });
      if (!this.state.filter) this.state.filter = 'all';
      if (!this.state.collapsedGroups) this.state.collapsedGroups = {};
      if (this.state.ligaHidden === undefined) this.state.ligaHidden = false;
      if (this.state.galleryVisible === undefined) this.state.galleryVisible = true;
    },

    renderAll: function() {
      this.updateTitleFromYear();
      this.renderAllGroups();
      this.renderPlayoffs();
      this.renderSummary();
      this.renderPodium();
      this.renderGallery();
      this.applyFilter(this.state.filter);
      this.applyLigaVisibility();
      this.updateAdminUI(); 
    },
    
    toggleAllLiga: function() {
      const ligaContent = document.getElementById('liga-content');
      const toggleBtn = document.getElementById('btn-toggle-all-liga');
      if (!ligaContent || !toggleBtn) return;
      this.state.ligaHidden = !this.state.ligaHidden;
      this.saveState();
      this.applyLigaVisibility();
    },
    
    applyLigaVisibility: function() {
      const ligaContent = document.getElementById('liga-content');
      const toggleBtn = document.getElementById('btn-toggle-all-liga');
      if (!ligaContent || !toggleBtn) return;
      if (this.state.ligaHidden) {
        ligaContent.classList.add('liga-content-hidden');
        toggleBtn.textContent = 'üëÅÔ∏è Amosar Todo';
      } else {
        ligaContent.classList.remove('liga-content-hidden');
        toggleBtn.textContent = 'üëÅÔ∏è Ocultar Todo';
      }
    },
    
    renderGallery: function() {
      const galleryArea = document.getElementById('galleryArea');
      const gallerySection = document.getElementById('gallery-section');
      if (!galleryArea || !gallerySection) return;
      galleryArea.innerHTML = '';
      
      const allTeamsWithPhotos = [];
      Object.keys(this.config.GROUPS).forEach(groupId => {
        const g = this.state.groups[groupId];
        if (g && g.teams) {
          g.teams.forEach(team => {
            if (team.photo && team.photo.trim() !== '') {
              allTeamsWithPhotos.push({ name: team.name, photo: team.photo, shield: team.shield, group: groupId });
            }
          });
        }
      });
      
      if ((this.config.isViewMode || this.state.galleryVisible) && allTeamsWithPhotos.length > 0) {
        gallerySection.style.display = 'block';
        allTeamsWithPhotos.forEach(team => {
          const item = document.createElement('div');
          item.className = 'gallery-item';
          item.innerHTML = `
            <img src="${team.photo}" alt="${team.name}" onerror="this.parentElement.style.display='none'">
            <div class="gallery-item-name">${this.getTeamShield(team)} ${team.name}</div>
            <div style="text-align:center;font-size:0.75rem;color:var(--muted);margin-top:4px">Grupo ${team.group}</div>
          `;
          galleryArea.appendChild(item);
        });
      } else {
        gallerySection.style.display = 'none';
      }
    },
    
    makeGroupCard: function(id) {
      const div = document.createElement('div');
      div.className = 'group-card';
      div.innerHTML = `<div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
          <h3>Grupo ${id}</h3>
          <div style="display:flex;gap:4px">
            <button id="btn-toggle-matches-${id}" class="gray" style="padding: 4px 8px; font-size: 0.8rem;" title="Amosar/Ocultar xornadas">üëÅÔ∏è</button>
            <button id="btn-toggle-shields-${id}" class="gray" style="padding: 4px 6px; font-size: 0.8rem;">‚öôÔ∏è Escudos</button>
            <button id="btn-toggle-photos-${id}" class="gray" style="padding: 4px 6px; font-size: 0.8rem;">üì∑ Fotos</button>
          </div>
        </div>
        <div class="teams-list" id="teams-${id}"></div>
        <div style="display:flex;gap:6px;margin-top:8px;flex-wrap:wrap">
          <button id="btn-add-team-${id}">‚ûï</button>
          <button id="btn-remove-team-${id}" class="gray">‚ûñ</button>
          <button id="btn-save-teams-${id}">üíæ Gardar</button>
        </div>
        <div style="margin-top:8px;display:flex;gap:6px;flex-wrap:wrap">
          <button id="btn-gen-schedule-${id}">üéØ Xerar</button>
          <button id="btn-clear-matches-${id}" class="gray">‚ôªÔ∏è Borrar</button>
        </div>
        <div id="matches-${id}" class="matches-container ${this.state.collapsedGroups[id] ? 'collapsed' : ''}"></div>
        <div id="standings-${id}" class="standings"></div>`;
      return div;
    },
    renderAllGroups: function() {
      Object.keys(this.config.LEVELS).forEach(level => {
        const container = document.getElementById(`groupsContainer${level}`);
        if(container) {
            container.innerHTML = '';
            this.config.LEVELS[level].forEach(groupId => {
                container.appendChild(this.makeGroupCard(groupId));
                this.renderTeamsInputs(groupId);
                this.renderMatchesAndStandings(groupId);
            });
        }
      });
    },
    renderTeamsInputs: function(id) { 
      const list = document.getElementById(`teams-${id}`); 
      if(!list) return; 
      list.innerHTML = ''; 
      const teams = this.state.groups[id]?.teams || []; 
      if (teams.length === 0) { 
        for (let i = 0; i < 4; i++) { 
          this.addTeamInput(list, '', `Equipo ${i + 1}`, '', ''); 
        } 
      } else { 
        teams.forEach(team => this.addTeamInput(list, team.name, 'Nome do equipo', team.shield || '', team.photo || '')); 
      } 
    },
    addTeamInput: function(list, name, placeholder, shieldUrl, photoUrl) { 
      const entry = document.createElement('div'); 
      entry.className = 'team-entry'; 
      entry.innerHTML = `
        <img src="${shieldUrl || 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs='}" 
             class="shield-preview" 
             alt="escudo" 
             onerror="this.style.display='none'" 
             style="display:${shieldUrl ? 'block' : 'none'}">
        <div class="inputs-wrapper">
          <input type="text" class="name-input" value="${name}" placeholder="${placeholder}">
          <input type="url" class="shield-input" value="${shieldUrl || ''}" placeholder="URL do Escudo">
          <input type="url" class="photo-input" value="${photoUrl || ''}" placeholder="üì∑ URL da Foto do Equipo">
          <img src="${photoUrl || ''}" class="photo-preview ${photoUrl ? 'visible' : ''}" alt="foto equipo" onerror="this.style.display='none'">
        </div>
      `; 
      
      const shieldInput = entry.querySelector('.shield-input');
      const shieldPreview = entry.querySelector('.shield-preview');
      shieldInput.addEventListener('input', function() {
        const url = this.value.trim();
        if(url) {
          shieldPreview.src = url;
          shieldPreview.style.display = 'block';
        } else {
          shieldPreview.style.display = 'none';
        }
      });
      
      const photoInput = entry.querySelector('.photo-input');
      const photoPreview = entry.querySelector('.photo-preview');
      photoInput.addEventListener('input', function() {
        const url = this.value.trim();
        if(url) {
          photoPreview.src = url;
          photoPreview.classList.add('visible');
        } else {
          photoPreview.classList.remove('visible');
        }
      });
      list.appendChild(entry); 
    },
    getTeamShield: function(team) { 
      if (!team) return ''; 
      return `<img src="${team.shield || 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs='}" class="shield-image" alt="escudo" onerror="this.style.display='none'">`;
    },
    
    renderMatchesAndStandings: function(id) { 
      const panel = document.getElementById(`matches-${id}`); 
      const standingsDiv = document.getElementById(`standings-${id}`); 
      if (!panel || !standingsDiv) return; 
      panel.innerHTML = ''; 
      standingsDiv.innerHTML = ''; 
      const g = this.state.groups[id] || { teams: [], rounds: [] }; 
      const teams = g.teams || []; 
      
      if (!g.rounds || g.rounds.length === 0) { 
        panel.innerHTML = '<div style="color:var(--muted);text-align:center;padding:10px 0;">Sen xornadas xeradas.</div>'; 
      } else { 
        g.rounds.forEach(round => { 
          const roundHeader = document.createElement('div'); 
          roundHeader.className = 'round-header'; 
          roundHeader.textContent = `Xornada ${round.roundNum}`; 
          panel.appendChild(roundHeader); 
          
          if (round.restingTeamIdx !== null && teams[round.restingTeamIdx]) { 
            const restingDiv = document.createElement('div'); 
            restingDiv.className = 'resting-team'; 
            restingDiv.innerHTML = `üßò Descansa: ${this.getTeamShield(teams[round.restingTeamIdx])} ${teams[round.restingTeamIdx].name}`; 
            panel.appendChild(restingDiv); 
          } 
          
          round.matches.forEach(m => { 
            const row = document.createElement('div'); 
            row.className = 'match'; 
            const teamA = teams[m.a], teamB = teams[m.b]; 
            if (!teamA || !teamB) return; 
            
            row.innerHTML = `
              <div class="teams">${this.getTeamShield(teamA)} ${teamA.name} vs ${this.getTeamShield(teamB)} ${teamB.name}</div>
              <div style="display:flex;gap:6px;align-items:center;">
                <input type="number" min="0" value="${m.scoreA ?? ''}" 
                       data-group-id="${id}" data-match-id="${m.id}" data-score-type="A" 
                       style="width:50px;padding:4px;text-align:center">
                <span>:</span>
                <input type="number" min="0" value="${m.scoreB ?? ''}" 
                       data-group-id="${id}" data-match-id="${m.id}" data-score-type="B" 
                       style="width:50px;padding:4px;text-align:center">
              </div>
              <div style="display:flex;gap:4px;align-items:center;font-size:0.85rem">
                <label title="Fair Play Equipo A" style="display:flex;align-items:center;gap:2px">
                  <input type="checkbox" class="fair-play-checkbox" 
                         data-group-id="${id}" data-match-id="${m.id}" data-fairplay-team="A"
                         ${m.fairPlayA ? 'checked' : ''}>
                  <span style="font-size:0.75rem">FP</span>
                </label>
                <span style="color:var(--muted)">|</span>
                <label title="Fair Play Equipo B" style="display:flex;align-items:center;gap:2px">
                  <input type="checkbox" class="fair-play-checkbox" 
                         data-group-id="${id}" data-match-id="${m.id}" data-fairplay-team="B"
                         ${m.fairPlayB ? 'checked' : ''}>
                  <span style="font-size:0.75rem">FP</span>
                </label>
              </div>
            `; 
            panel.appendChild(row); 
          }); 
        }); 
      } 
      this.renderStandings(id); 
    },
    
    renderStandings: function(id) { 
      const container = document.getElementById(`standings-${id}`); 
      if (!container) return; 
      container.innerHTML = ''; 
      const stats = this.computeStatsForGroup(id); 
      if (stats.length === 0) return;
      
      const table = document.createElement('table');
      table.innerHTML = `<thead><tr><th class="num">#</th><th class="team-col">Equipo</th><th class="num">Pts</th><th class="num">X</th><th class="num">V</th><th class="num">E</th><th class="num">D</th><th class="num">GF</th><th class="num">GC</th><th class="num">DG</th></tr></thead>`;
      const tbody = document.createElement('tbody');
      stats.forEach((s, i) => { 
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="num"><b>${i + 1}</b></td><td class="team-col">${this.getTeamShield(s)} ${s.name}</td><td class="num">${s.PTS}</td><td class="num">${s.P}</td><td class="num">${s.W}</td><td class="num">${s.D}</td><td class="num">${s.L}</td><td class="num">${s.GF}</td><td class="num">${s.GA}</td><td class="num">${s.GD}</td>`; 
        tbody.appendChild(tr); 
      });
      table.appendChild(tbody); 
      container.appendChild(table);
      this.renderGroupAwards(id, container);
    },
    
    renderGroupAwards: function(id, container) {
      const g = this.state.groups[id];
      if (!g || !g.teams || g.teams.length === 0) return;
      
      const stats = this.computeStatsForGroup(id);
      if (stats.length === 0) return;
      
      const topScorer = stats.reduce((max, s) => s.GF > max.GF ? s : max, stats[0]);
      const bestDefense = stats.reduce((min, s) => s.GA < min.GA ? s : min, stats[0]);
      
      const fairPlayScores = g.teams.map((team, idx) => {
        let fpPoints = 0;
        (g.rounds || []).flatMap(r => r.matches).forEach(m => {
          if (m.a === idx && m.fairPlayA) fpPoints++;
          if (m.b === idx && m.fairPlayB) fpPoints++;
        });
        return { idx, name: team.name, shield: team.shield, photo: team.photo, fpPoints };
      });
      const fairPlayWinner = fairPlayScores.reduce((max, s) => s.fpPoints > max.fpPoints ? s : max, fairPlayScores[0]);
      
      const hasData = g.rounds && g.rounds.length > 0 && g.rounds.some(r => r.matches.some(m => m.scoreA !== null));
      if (!hasData) return;
      
      const awardsSection = document.createElement('div');
      awardsSection.className = 'award-section';
      awardsSection.innerHTML = `
        <h4 style="margin:0 0 12px;color:var(--accent);font-size:0.9rem">üèÖ Premios do Grupo ${id}</h4>
        <div class="award-item">
          <span class="award-medal">‚öΩ</span>
          <div style="flex:1">
            <strong>Equipo M√°s Goleador</strong>
            <div style="font-size:0.85rem;color:var(--muted)">${this.getTeamShield(topScorer)} ${topScorer.name} - ${topScorer.GF} goles</div>
          </div>
          ${topScorer.photo ? `<img src="${topScorer.photo}" class="award-photo" alt="${topScorer.name}" onerror="this.style.display='none'">` : ''}
        </div>
        <div class="award-item">
          <span class="award-medal">üõ°Ô∏è</span>
          <div style="flex:1">
            <strong>Porter√≠a Menos Batida</strong>
            <div style="font-size:0.85rem;color:var(--muted)">${this.getTeamShield(bestDefense)} ${bestDefense.name} - ${bestDefense.GA} goles recibidos</div>
          </div>
          ${bestDefense.photo ? `<img src="${bestDefense.photo}" class="award-photo" alt="${bestDefense.name}" onerror="this.style.display='none'">` : ''}
        </div>
        <div class="award-item">
          <span class="award-medal">ü§ù</span>
          <div style="flex:1">
            <strong>Premio Fair Play</strong>
            <div style="font-size:0.85rem;color:var(--muted)">${this.getTeamShield(fairPlayWinner)} ${fairPlayWinner.name} - ${fairPlayWinner.fpPoints} partidos con fair play</div>
          </div>
          ${fairPlayWinner.photo ? `<img src="${fairPlayWinner.photo}" class="award-photo" alt="${fairPlayWinner.name}" onerror="this.style.display='none'">` : ''}
        </div>
      `;
      container.appendChild(awardsSection);
    },
    
    computeStatsForGroup: function(id) { 
      const g = this.state.groups[id] || { teams: [], rounds: [] }; 
      const teams = g.teams || []; 
      const stats = teams.map((t, idx) => ({ name: t.name, shield: t.shield, photo: t.photo, idx, P: 0, W: 0, D: 0, L: 0, GF: 0, GA: 0, GD: 0, PTS: 0 })); 
      
      (g.rounds || []).flatMap(r => r.matches).forEach(m => { 
        // 1. Validar que os datos existen
        if (m.scoreA === null || m.scoreA === undefined || m.scoreA === "" || 
            m.scoreB === null || m.scoreB === undefined || m.scoreB === "") return; 
        
        // 2. Converter a n√∫mero real (evita o erro NaN)
        const sA = Number(m.scoreA);
        const sB = Number(m.scoreB);

        // 3. Se non √© un n√∫mero v√°lido, ignorar partido
        if (isNaN(sA) || isNaN(sB)) return;

        const a = m.a, b = m.b; 
        if (!stats[a] || !stats[b]) return; 
        
        stats[a].P++; stats[b].P++; 
        stats[a].GF += sA; stats[a].GA += sB; 
        stats[b].GF += sB; stats[b].GA += sA; 
        
        if (sA > sB) { stats[a].W++; stats[b].L++; stats[a].PTS += 3; } 
        else if (sA < sB) { stats[b].W++; stats[a].L++; stats[b].PTS += 3; } 
        else { stats[a].D++; stats[b].D++; stats[a].PTS += 1; stats[b].PTS += 1; } 
      }); 
      
      stats.forEach(s => s.GD = s.GF - s.GA); 
      
      stats.sort((x, y) => { 
        if (y.PTS !== x.PTS) return y.PTS - x.PTS; 
        if (y.GD !== x.GD) return y.GD - x.GD; 
        if (y.GF !== x.GF) return y.GF - x.GF;
        const h2h = this.computeHeadToHead(g, [x.idx, y.idx]);
        if (h2h && h2h[x.idx] && h2h[y.idx]) {
          if (h2h[y.idx].PTS !== h2h[x.idx].PTS) return h2h[y.idx].PTS - h2h[x.idx].PTS;
          if (h2h[y.idx].GD !== h2h[x.idx].GD) return h2h[y.idx].GD - h2h[x.idx].GD;
          if (h2h[y.idx].GF !== h2h[x.idx].GF) return h2h[y.idx].GF - h2h[x.idx].GF;
        }
        return 0;
      }); 
      return stats; 
    },
    
    computeHeadToHead: function(group, teamIndices) {
      const h2h = {};
      teamIndices.forEach(idx => { h2h[idx] = { PTS: 0, GF: 0, GA: 0, GD: 0 }; });
      
      (group.rounds || []).flatMap(r => r.matches).forEach(m => {
        if (m.scoreA === null || m.scoreB === null) return;
        const isRelevantMatch = teamIndices.includes(m.a) && teamIndices.includes(m.b);
        if (!isRelevantMatch) return;
        
        const a = m.a, b = m.b, sA = m.scoreA, sB = m.scoreB;
        h2h[a].GF += sA; h2h[a].GA += sB;
        h2h[b].GF += sB; h2h[b].GA += sA;
        if (sA > sB) { h2h[a].PTS += 3; } 
        else if (sA < sB) { h2h[b].PTS += 3; } 
        else { h2h[a].PTS += 1; h2h[b].PTS += 1; }
      });
      Object.keys(h2h).forEach(idx => { h2h[idx].GD = h2h[idx].GF - h2h[idx].GA; });
      return h2h;
    },
    
    top2FromGroup: function(id) { 
      return this.computeStatsForGroup(id).slice(0, 2); 
    },
    
    allMatchesCompletedForGroup: function(id) { 
      const g = this.state.groups[id]; 
      if (!g || !g.rounds || g.rounds.length === 0) return false; 
      return g.rounds.flatMap(r => r.matches).every(m => m.scoreA !== null && m.scoreB !== null); 
    },
    
    toggleMatchesVisibility: function(id) {
      this.state.collapsedGroups[id] = !this.state.collapsedGroups[id];
      const container = document.getElementById(`matches-${id}`);
      if(container) { container.classList.toggle('collapsed'); }
      this.saveState();
    },
    
    addTeam: function(id) { 
      const list = document.getElementById(`teams-${id}`); 
      this.addTeamInput(list, '', `Equipo ${list.children.length + 1}`, '', ''); 
    },
    
    removeTeam: function(id) { 
      const list = document.getElementById(`teams-${id}`); 
      if (list.lastElementChild) list.removeChild(list.lastElementChild); 
    },
    
    saveTeams: function(id) { 
      const list = document.getElementById(`teams-${id}`); 
      const newTeams = []; 
      for (const child of list.children) { 
        const name = child.querySelector('.name-input').value.trim(); 
        const shield = child.querySelector('.shield-input').value.trim(); 
        const photo = child.querySelector('.photo-input').value.trim();
        if (name) newTeams.push({ name, shield, photo }); 
      } 
      
      const oldTeams = this.state.groups[id].teams || [];
      const namesChanged = this.haveTeamNamesChanged(oldTeams, newTeams);
      
      if (namesChanged) {
        if (oldTeams.length > 0 && this.state.groups[id].rounds && this.state.groups[id].rounds.length > 0) {
          if (!confirm('Cambiaches os nomes dos equipos. Isto borrar√° todas as xornadas e resultados deste grupo. Continuar?')) { return; }
        }
        this.state.groups[id].teams = newTeams; 
        this.state.groups[id].rounds = []; 
        this.showBanner('Equipos gardados. Xornadas borradas porque cambiaron os nomes.');
      } else {
        this.state.groups[id].teams = newTeams;
        this.showBanner('Escudos e fotos actualizados. Xornadas conservadas.');
      }
      this.saveState(); 
      this.renderMatchesAndStandings(id); 
    },
    
    haveTeamNamesChanged: function(oldTeams, newTeams) {
      if (oldTeams.length !== newTeams.length) return true;
      for (let i = 0; i < oldTeams.length; i++) {
        if (oldTeams[i].name !== newTeams[i].name) { return true; }
      }
      return false;
    },
    
    generateSchedule: function(id) { 
      const g = this.state.groups[id]; 
      if (!g || !g.teams || g.teams.length < 2) { 
        this.showBanner('Engade polo menos 2 equipos.'); 
        return; 
      } 
      let teamIndices = g.teams.map((_, i) => i); 
      const rounds = []; 
      const REST_KEY = -1; 
      if (teamIndices.length % 2 !== 0) teamIndices.push(REST_KEY); 
      const numRounds = teamIndices.length - 1; 
      for (let i = 0; i < numRounds; i++) { 
        const roundMatches = []; 
        let restingTeamIdx = null; 
        for (let j = 0; j < teamIndices.length / 2; j++) { 
          const teamA_idx = teamIndices[j], teamB_idx = teamIndices[teamIndices.length - 1 - j]; 
          if (teamA_idx === REST_KEY) restingTeamIdx = teamB_idx; 
          else if (teamB_idx === REST_KEY) restingTeamIdx = teamA_idx; 
          else roundMatches.push({ id: `${id}_r${i}_${j}`, a: teamA_idx, b: teamB_idx, scoreA: null, scoreB: null, fairPlayA: false, fairPlayB: false }); 
        } 
        rounds.push({ roundNum: i + 1, matches: roundMatches, restingTeamIdx }); 
        teamIndices.splice(1, 0, teamIndices.pop()); 
      } 
      const secondLegRounds = rounds.map((r, i) => ({ 
        roundNum: numRounds + i + 1, 
        matches: r.matches.map((m, j) => ({ id: `${id}_r${numRounds + i}_${j}`, a: m.b, b: m.a, scoreA: null, scoreB: null, fairPlayA: false, fairPlayB: false })), 
        restingTeamIdx: r.restingTeamIdx 
      })); 
      this.state.groups[id].rounds = [...rounds, ...secondLegRounds]; 
      this.saveState(); 
      this.renderMatchesAndStandings(id); 
    },
    
    clearMatches: function(id) { 
      if (confirm('Queres borrar todas as xornadas deste grupo?')) { 
        this.state.groups[id].rounds = []; 
        this.saveState(); 
        this.renderMatchesAndStandings(id); 
      } 
    },
    
    handleScoreChange: function(event) { 
      const input = event.target; 
      const groupId = input.dataset.groupId; 
      const matchId = input.dataset.matchId; 
      let match = null; 
      for (const round of this.state.groups[groupId].rounds) { 
        match = round.matches.find(m => m.id === matchId); 
        if (match) break; 
      } 
      if (!match) return; 
      const scoreA_input = document.querySelector(`input[data-match-id="${matchId}"][data-score-type="A"]`); 
      const scoreB_input = document.querySelector(`input[data-match-id="${matchId}"][data-score-type="B"]`); 
      match.scoreA = scoreA_input.value === '' ? null : Number(scoreA_input.value); 
      match.scoreB = scoreB_input.value === '' ? null : Number(scoreB_input.value); 
      this.saveState(); 
      this.renderStandings(groupId); 
      this.checkAutoPlayoffs('2ciclo'); 
      this.checkAutoPlayoffs('3ciclo'); 
    },
    
    handleFairPlayChange: function(event) {
      const checkbox = event.target;
      const groupId = checkbox.dataset.groupId;
      const matchId = checkbox.dataset.matchId;
      const team = checkbox.dataset.fairplayTeam;
      let match = null;
      for (const round of this.state.groups[groupId].rounds) { 
        match = round.matches.find(m => m.id === matchId); 
        if (match) break; 
      }
      if (!match) return;
      if (team === 'A') { match.fairPlayA = checkbox.checked; } 
      else { match.fairPlayB = checkbox.checked; }
      this.saveState();
      this.renderStandings(groupId);
    },
    
    renderPlayoffs: function() { 
      this.renderPlayoffsForCycle('2ciclo'); 
      this.renderPlayoffsForCycle('3ciclo'); 
    },
    
    renderPlayoffsForCycle: function(cycle) { 
      const area = document.getElementById('playoffsArea'); 
      const oldCycleContent = document.getElementById(`playoffs-content-${cycle}`); 
      if(oldCycleContent) oldCycleContent.remove(); 
      
      const bracket = this.state.playoffs[cycle]; 
      if (!bracket || !bracket.levels) return; 
      
      const cycleContent = document.createElement('div'); 
      cycleContent.id = `playoffs-content-${cycle}`; 
      
      const title = document.createElement('h4'); 
      title.style.cssText = 'color:var(--accent); margin-top: 16px;'; 
      title.textContent = cycle === '2ciclo' ? 'Fase Final 2¬∫ Ciclo' : 'Fase Final 3¬∫ Ciclo'; 
      cycleContent.appendChild(title); 
      
      const renderMatchUI = (match, container, label) => { 
        const section = document.createElement('div');
        section.className = 'playoff-section';
        if(label) {
          const lbl = document.createElement('h5');
          lbl.textContent = label;
          section.appendChild(lbl);
        }
        
        const div = document.createElement('div'); 
        div.className = 'playoff-match'; 
        const teamA = match.a, teamB = match.b; 
        if(!teamA || !teamB) return; 
        
        const disabledAttr = this.user ? '' : 'disabled';
        const isTied = match.scoreA !== null && match.scoreB !== null && match.scoreA === match.scoreB;
        
        div.innerHTML = `
          <div style="flex:1"><b>${this.getTeamShield(teamA)} ${teamA.name}</b></div>
          <div style="display:flex;flex-direction:column;align-items:center;gap:8px">
            <div class="score-inputs">
              <input type="number" min="0" style="width:50px;padding:4px;text-align:center;font-weight:bold" 
                     value="${match.scoreA ?? ''}" ${disabledAttr} 
                     data-playoff-match="${match.id}" data-score-type="A" 
                     placeholder="0">
              <span style="font-weight:bold">:</span>
              <input type="number" min="0" style="width:50px;padding:4px;text-align:center;font-weight:bold" 
                     value="${match.scoreB ?? ''}" ${disabledAttr} 
                     data-playoff-match="${match.id}" data-score-type="B" 
                     placeholder="0">
            </div>
            ${isTied ? `
              <div class="extra-time-section" style="width:100%">
                <div class="extra-time-label">‚è±Ô∏è Pr√≥rroga (Gol de Ouro)</div>
                <div class="score-inputs" style="justify-content:center">
                  <input type="number" min="0" max="99" style="width:45px;padding:3px;text-align:center;font-size:0.85rem" 
                         value="${match.extraTimeA ?? ''}" ${disabledAttr} 
                         data-playoff-match="${match.id}" data-extratime-type="A" 
                         placeholder="0">
                  <span style="font-size:0.85rem">-</span>
                  <input type="number" min="0" max="99" style="width:45px;padding:3px;text-align:center;font-size:0.85rem" 
                         value="${match.extraTimeB ?? ''}" ${disabledAttr} 
                         data-playoff-match="${match.id}" data-extratime-type="B" 
                         placeholder="0">
                </div>
              </div>
            ` : ''}
            ${isTied && match.extraTimeA !== null && match.extraTimeB !== null && match.extraTimeA === match.extraTimeB ? `
              <div class="penalty-section" style="width:100%">
                <div class="penalty-label">ü•Ö Lanzamentos de Penaltis</div>
                <div class="score-inputs" style="justify-content:center">
                  <input type="number" min="0" max="99" style="width:45px;padding:3px;text-align:center;font-size:0.85rem" 
                         value="${match.penaltyA ?? ''}" ${disabledAttr} 
                         data-playoff-match="${match.id}" data-penalty-type="A" 
                         placeholder="0">
                  <span style="font-size:0.85rem">-</span>
                  <input type="number" min="0" max="99" style="width:45px;padding:3px;text-align:center;font-size:0.85rem" 
                         value="${match.penaltyB ?? ''}" ${disabledAttr} 
                         data-playoff-match="${match.id}" data-penalty-type="B" 
                         placeholder="0">
                </div>
              </div>
            ` : ''}
          </div>
          <div style="flex:1;text-align:right"><b>${this.getTeamShield(teamB)} ${teamB.name}</b></div>
        `; 
        
        if(this.user) {
          const scoreInputs = div.querySelectorAll('input[data-score-type]'); 
          scoreInputs[0].onchange = () => {
            match.scoreA = scoreInputs[0].value === '' ? null : Number(scoreInputs[0].value);
            match.extraTimeA = null; match.extraTimeB = null; match.penaltyA = null; match.penaltyB = null;
            this.advanceAndRender(cycle);
          }; 
          scoreInputs[1].onchange = () => {
            match.scoreB = scoreInputs[1].value === '' ? null : Number(scoreInputs[1].value);
            match.extraTimeA = null; match.extraTimeB = null; match.penaltyA = null; match.penaltyB = null;
            this.advanceAndRender(cycle);
          };
          
          const extraTimeInputs = div.querySelectorAll('input[data-extratime-type]');
          if(extraTimeInputs.length > 0) {
            extraTimeInputs[0].onchange = () => {
              match.extraTimeA = extraTimeInputs[0].value === '' ? null : Number(extraTimeInputs[0].value);
              match.penaltyA = null; match.penaltyB = null;
              this.advanceAndRender(cycle);
            };
            extraTimeInputs[1].onchange = () => {
              match.extraTimeB = extraTimeInputs[1].value === '' ? null : Number(extraTimeInputs[1].value);
              match.penaltyA = null; match.penaltyB = null;
              this.advanceAndRender(cycle);
            };
          }
          
          const penaltyInputs = div.querySelectorAll('input[data-penalty-type]');
          if(penaltyInputs.length > 0) {
            penaltyInputs[0].onchange = () => {
              match.penaltyA = penaltyInputs[0].value === '' ? null : Number(penaltyInputs[0].value);
              this.advanceAndRender(cycle);
            };
            penaltyInputs[1].onchange = () => {
              match.penaltyB = penaltyInputs[1].value === '' ? null : Number(penaltyInputs[1].value);
              this.advanceAndRender(cycle);
            };
          }
        }
        
        section.appendChild(div); 
        container.appendChild(section); 
      }; 
      
      Object.keys(bracket.levels).forEach(level => { 
        const lvl = bracket.levels[level]; 
        const levelTitle = document.createElement('h4');
        levelTitle.style.cssText = 'color:var(--muted);margin-top:12px;font-size:0.95rem';
        levelTitle.textContent = `Nivel ${level}¬∫`;
        cycleContent.appendChild(levelTitle);
        
        if (lvl.semis && lvl.semis.length > 0) {
          lvl.semis.forEach((m, idx) => renderMatchUI(m, cycleContent, `Semifinal ${idx + 1}`));
        }
        
        if (lvl.final) {
          renderMatchUI(lvl.final, cycleContent, `üèÜ Final ${level}¬∫`);
        }
        
        if(lvl.winner) {
          const winnerDiv = document.createElement('div');
          winnerDiv.style.cssText = 'background:#e8f5e9;padding:8px;border-radius:6px;margin-top:8px;text-align:center';
          winnerDiv.innerHTML = `‚úÖ <strong>Ga√±ador ${level}¬∫:</strong> ${this.getTeamShield(lvl.winner)} ${lvl.winner.name}`;
          cycleContent.appendChild(winnerDiv);
        }
      }); 
      
      if (bracket.cycleFinal) { 
        const sep = document.createElement('h4'); 
        sep.style.cssText = 'color:var(--danger);margin-top:16px;font-size:1.1rem;text-align:center'; 
        sep.textContent = `üèÜ GRAN FINAL DO ${cycle === '2ciclo' ? '2¬∫' : '3¬∫'} CICLO`; 
        cycleContent.appendChild(sep); 
        renderMatchUI(bracket.cycleFinal, cycleContent, null); 
        
        if(bracket.cycleFinal.winner) {
          const championDiv = document.createElement('div');
          championDiv.style.cssText = 'background:linear-gradient(135deg,#ffd700,#ffed4e);padding:12px;border-radius:8px;margin-top:12px;text-align:center;font-size:1.1rem;box-shadow:0 4px 12px rgba(255,215,0,0.3)';
          championDiv.className = 'champion-badge';
          championDiv.innerHTML = `ü•á <strong>CAMPE√ìN ${cycle === '2ciclo' ? '2¬∫' : '3¬∫'} CICLO:</strong> ${this.getTeamShield(bracket.cycleFinal.winner)} <strong>${bracket.cycleFinal.winner.name}</strong>`;
          cycleContent.appendChild(championDiv);
          
          if (!bracket.cycleFinal.confettiShown) {
            bracket.cycleFinal.confettiShown = true;
            setTimeout(() => this.launchConfetti(), 300);
          }
        }
      } 
      area.appendChild(cycleContent); 
    },
    
    launchConfetti: function() {
      const colors = ['#ffd700', '#ff6b6b', '#4ecdc4', '#45b7d1', '#f9ca24', '#6c5ce7', '#a29bfe', '#fd79a8', '#fdcb6e', '#00b894'];
      const confettiCount = 150;
      for (let i = 0; i < confettiCount; i++) {
        setTimeout(() => {
          const confetti = document.createElement('div');
          confetti.className = 'confetti';
          confetti.style.position = 'fixed';
          confetti.style.left = Math.random() * 100 + '%';
          confetti.style.top = '-20px';
          confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
          confetti.style.width = (Math.random() * 10 + 5) + 'px';
          confetti.style.height = (Math.random() * 10 + 5) + 'px';
          confetti.style.pointerEvents = 'none';
          confetti.style.zIndex = '10000';
          if (Math.random() > 0.5) { confetti.style.borderRadius = '50%'; }
          const duration = (Math.random() * 2 + 2);
          confetti.style.animation = `confetti-fall ${duration}s linear forwards`;
          document.body.appendChild(confetti);
          setTimeout(() => { if (confetti && confetti.parentNode) { confetti.remove(); } }, duration * 1000 + 100);
        }, i * 10);
      }
      this.showBanner('üéâ ¬°CAMPE√ìN! üèÜ', 3000);
    },
    
    confirmReset: function() { 
      if (confirm('Est√°s seguro de que queres reiniciar todo o torneo? Borraranse todos os datos.')) {
        db.ref('torneo').remove()
          .then(() => {
             this.initEmptyState();
             this.renderAll();
             this.showBanner("Torneo reiniciado.");
          })
          .catch(e => alert(e.message));
      } 
    },
    
    exportData: function() { 
      const s = JSON.stringify(this.state, null, 2); 
      navigator.clipboard?.writeText(s).then(() => this.showBanner('Datos copiados ao portapapeis.'), () => { 
        document.getElementById('import-text').value = s; 
        this.showImport(); 
        this.showBanner('Copia o JSON manualmente.'); 
      }); 
    },
    
    exportToExcel: function() {
      let csv = '\uFEFFXIX TORNEO DE NADAL\nCurso: ' + (this.state.year||'') + '\n\n';
      Object.keys(this.config.GROUPS).forEach(groupId => {
        const stats = this.computeStatsForGroup(groupId);
        if (!stats.length) return;
        csv += `\nGRUPO ${groupId}\nPos,Equipo,Puntos,X,V,E,D,GF,GC,DG\n`;
        stats.forEach((t, i) => csv += `${i+1},${t.name},${t.PTS},${t.P},${t.W},${t.D},${t.L},${t.GF},${t.GA},${t.GD}\n`);
      });
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url; link.download = 'torneo_balaidos.csv';
      document.body.appendChild(link); link.click(); document.body.removeChild(link);
    },
    
    printPage: function() { window.print(); },
    
    saveYear: function() { 
      const v = document.getElementById('schoolYear').value.trim(); 
      if (v) this.state.year = v; 
      this.saveState(); 
      this.updateTitleFromYear(); 
      this.showBanner('Curso escolar gardado: ' + this.state.year); 
    },
    
    toggleProjectorMode: function() { 
      const body = document.body; 
      body.classList.toggle('projector-mode'); 
      document.getElementById('btn-projector').style.display = body.classList.contains('projector-mode') ? 'none' : 'block'; 
      document.getElementById('btn-exit-projector').style.display = body.classList.contains('projector-mode') ? 'block' : 'none'; 
    },
    
    showBanner: function(msg, time = 4000) { 
      let bannerTimeout; 
      const b = document.getElementById('banner'); 
      b.textContent = msg; 
      b.style.display = 'block'; 
      if (bannerTimeout) clearTimeout(bannerTimeout); 
      bannerTimeout = setTimeout(() => { b.style.display = 'none'; }, time); 
    },
    
    updateTitleFromYear: function() { 
      const toRoman = num => { 
        if (num <= 0) return ''; 
        const r = [[1000, 'M'], [900, 'CM'], [500, 'D'], [400, 'CD'], [100, 'C'], [90, 'XC'], [50, 'L'], [40, 'XL'], [10, 'X'], [9, 'IX'], [5, 'V'], [4, 'IV'], [1, 'I']]; 
        let s = ''; 
        for (const [v, c] of r) { 
          while (num >= v) { s += c; num -= v; } 
        } 
        return s; 
      }; 
      const parseFirstYear = str => { 
        if (!str) return null; 
        const m = str.match(/(\d{4})/); 
        return m ? Number(m[1]) : null; 
      }; 
      const y = this.state.year || document.getElementById('schoolYear').value || '2025‚Äì2026'; 
      const fy = parseFirstYear(y) || this.config.BASE_EDIT_YEAR; 
      const ed = this.config.BASE_EDITION_NUM + (fy - this.config.BASE_EDIT_YEAR); 
      const ro = toRoman(ed); 
      document.getElementById('mainTitle').textContent = `üèë ${ro ? ro + ' ' : ''}Torneo de Nadal de h√≥ckey CEIP Bala√≠dos`; 
      document.getElementById('subtitle').textContent = `Curso escolar: ${y}`; 
    },
    
    applyFilter: function(filter) {
      document.getElementById('cycle-2-container').style.display = (filter === 'all' || filter === 'c2' || filter === '3' || filter === '4') ? 'block' : 'none';
      document.getElementById('cycle-3-container').style.display = (filter === 'all' || filter === 'c3' || filter === '5' || filter === '6') ? 'block' : 'none';
      ['3', '4'].forEach(level => { 
        const cont = document.getElementById(`level-${level}-container`); 
        if(cont) cont.style.display = (filter === 'all' || filter === 'c2' || filter === level) ? 'block' : 'none'; 
      });
      ['5', '6'].forEach(level => { 
        const cont = document.getElementById(`level-${level}-container`); 
        if(cont) cont.style.display = (filter === 'all' || filter === 'c3' || filter === level) ? 'block' : 'none'; 
      });
      document.querySelectorAll('.filter-bar button').forEach(btn => btn.classList.remove('active'));
      document.getElementById(`btn-filter-${filter}`).classList.add('active');
      this.state.filter = filter;
      if(this.user) this.saveState();
    },
    
    bindEvents: function() {
      document.getElementById('btn-save-year').addEventListener('click', () => this.saveYear());
      document.getElementById('btn-print').addEventListener('click', () => this.printPage());
      document.getElementById('btn-projector').addEventListener('click', () => this.toggleProjectorMode());
      document.getElementById('btn-exit-projector').addEventListener('click', () => this.toggleProjectorMode());
      document.getElementById('btn-gen-playoffs-2').addEventListener('click', () => this.generatePlayoffForCycle('2ciclo'));
      document.getElementById('btn-gen-playoffs-3').addEventListener('click', () => this.generatePlayoffForCycle('3ciclo'));
      document.getElementById('btn-export').addEventListener('click', () => this.exportData());
      document.getElementById('btn-export-excel').addEventListener('click', () => this.exportToExcel());
      document.getElementById('btn-reset').addEventListener('click', () => this.confirmReset());
      document.getElementById('btn-toggle-all-liga').addEventListener('click', () => this.toggleAllLiga());
      document.getElementById('btn-color-picker').addEventListener('click', () => this.toggleColorPicker());
      
      const btnGallery = document.getElementById('btn-toggle-gallery');
      if (btnGallery) {
        btnGallery.addEventListener('click', () => {
          this.state.galleryVisible = !this.state.galleryVisible;
          this.saveState();
          this.renderGallery();
        });
      }
      
      const btnShowImport = document.getElementById('btn-show-import');
      if (btnShowImport) btnShowImport.addEventListener('click', () => { document.getElementById('import-area').style.display = 'block'; });
      
      const btnCancelImport = document.getElementById('btn-cancel-import');
      if (btnCancelImport) btnCancelImport.addEventListener('click', () => { document.getElementById('import-area').style.display = 'none'; });
      
      const btnImport = document.getElementById('btn-import');
      if (btnImport) btnImport.addEventListener('click', () => this.importFromText());

      document.querySelectorAll('.color-option').forEach(option => {
        option.addEventListener('click', () => {
          this.changeTheme(option.dataset.theme);
        });
      });
      
      document.addEventListener('click', (event) => {
        const picker = document.getElementById('color-picker');
        const btn = document.getElementById('btn-color-picker');
        if (picker.classList.contains('show') && 
            !picker.contains(event.target) && 
            !btn.contains(event.target)) {
          picker.classList.remove('show');
        }
      });
      
      document.getElementById('btn-filter-all').addEventListener('click', () => this.applyFilter('all'));
      document.getElementById('btn-filter-c2').addEventListener('click', () => this.applyFilter('c2'));
      document.getElementById('btn-filter-c3').addEventListener('click', () => this.applyFilter('c3'));
      document.getElementById('btn-filter-3').addEventListener('click', () => this.applyFilter('3'));
      document.getElementById('btn-filter-4').addEventListener('click', () => this.applyFilter('4'));
      document.getElementById('btn-filter-5').addEventListener('click', () => this.applyFilter('5'));
      document.getElementById('btn-filter-6').addEventListener('click', () => this.applyFilter('6'));
      
      document.addEventListener('click', (event) => {
        const button = event.target.closest('button[id^="btn-"]');
        if (!button) return;
        const buttonId = button.id;
        
        const matchToggle = buttonId.match(/^btn-toggle-matches-(.+)$/);
        const matchShields = buttonId.match(/^btn-toggle-shields-(.+)$/);
        const matchPhotos = buttonId.match(/^btn-toggle-photos-(.+)$/);
        const matchAdd = buttonId.match(/^btn-add-team-(.+)$/);
        const matchRemove = buttonId.match(/^btn-remove-team-(.+)$/);
        const matchSave = buttonId.match(/^btn-save-teams-(.+)$/);
        const matchGen = buttonId.match(/^btn-gen-schedule-(.+)$/);
        const matchClear = buttonId.match(/^btn-clear-matches-(.+)$/);
        
        if (matchToggle) {
          this.toggleMatchesVisibility(matchToggle[1]);
        } else if (matchShields) {
          const teamList = document.getElementById(`teams-${matchShields[1]}`);
          if(teamList) {
            teamList.querySelectorAll('.team-entry').forEach(entry => {
              entry.classList.toggle('edit-shield');
            });
          }
        } else if (matchPhotos) {
          const teamList = document.getElementById(`teams-${matchPhotos[1]}`);
          if(teamList) {
            teamList.querySelectorAll('.team-entry').forEach(entry => {
              entry.classList.toggle('edit-photos');
            });
          }
        } else if (matchAdd) {
          this.addTeam(matchAdd[1]);
        } else if (matchRemove) {
          this.removeTeam(matchRemove[1]);
        } else if (matchSave) {
          this.saveTeams(matchSave[1]);
        } else if (matchGen) {
          this.generateSchedule(matchGen[1]);
        } else if (matchClear) {
          this.clearMatches(matchClear[1]);
        }
      });
      
      document.addEventListener('change', (event) => {
        if (event.target.matches('input[type="number"][data-match-id]')) {
          this.handleScoreChange(event);
        }
        if (event.target.matches('input[type="checkbox"][data-fairplay-team]')) {
          this.handleFairPlayChange(event);
        }
      });
    },

    loadTheme: function() {
      const savedTheme = localStorage.getItem(this.config.THEME_KEY) || 'blue';
      document.body.setAttribute('data-theme', savedTheme);
      this.updateActiveTheme(savedTheme);
    },
    
    updateActiveTheme: function(theme) {
      document.querySelectorAll('.color-option').forEach(opt => {
        opt.classList.remove('active');
        if (opt.dataset.theme === theme) {
          opt.classList.add('active');
        }
      });
    },
    
    changeTheme: function(theme) {
      document.body.setAttribute('data-theme', theme);
      localStorage.setItem(this.config.THEME_KEY, theme);
      this.updateActiveTheme(theme);
    },
    
    getThemeName: function(theme) { return theme; },
    toggleColorPicker: function() {
      const picker = document.getElementById('color-picker');
      picker.classList.toggle('show');
    }
  };

  window.torneoApp.init();
});
</script>
</body>
</html>
